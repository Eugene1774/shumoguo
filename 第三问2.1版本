import pandas as pd
import numpy as np
from sklearn.cluster import AgglomerativeClustering
from sklearn.ensemble import RandomForestRegressor
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.cluster.hierarchy import dendrogram, linkage
import matplotlib
import re
from scipy.interpolate import interp1d

# è®¾ç½®ä¸­æ–‡å­—ä½“
matplotlib.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans']
matplotlib.rcParams['axes.unicode_minus'] = False

# è¯»å–æ•°æ®
df_male = pd.read_csv('cleaned_dataæœ€ç»ˆ(1).csv')


# è½¬æ¢å­•å‘¨æ ¼å¼ä¸ºæ•°å€¼
def convert_week_to_numeric(week_str):
    if pd.isna(week_str):
        return np.nan
    if isinstance(week_str, (int, float)):
        return week_str

    week_str = str(week_str).lower().replace('å‘¨', '').replace('w', '')
    match = re.search(r'(\d+)(?:\+(\d+))?', week_str)
    if match:
        weeks = int(match.group(1))
        days = int(match.group(2)) if match.group(2) else 0
        return weeks + days / 7
    return np.nan


df_male['æ£€æµ‹å­•å‘¨æ•°å€¼'] = df_male['æ£€æµ‹å­•å‘¨'].apply(convert_week_to_numeric)

# å…³é”®ä¿®æ­£ï¼šå¯¹æ¯ä¸ªå­•å¦‡æ‰¾åˆ°æœ€æ—©è¾¾æ ‡æ—¶é—´
print("å¤„ç†æ¯ä¸ªå­•å¦‡çš„æœ€æ—©è¾¾æ ‡æ—¶é—´...")

# æ ‡è®°è¾¾æ ‡æ ·æœ¬
df_male['è¾¾æ ‡'] = df_male['YæŸ“è‰²ä½“æµ“åº¦'] >= 0.04

# å¯¹æ¯ä¸ªå­•å¦‡ï¼Œæ‰¾åˆ°æœ€æ—©è¾¾æ ‡çš„æ£€æµ‹æ—¶é—´
earliest_pass_df = df_male[df_male['è¾¾æ ‡']].groupby('å­•å¦‡ä»£ç ').agg({
    'æ£€æµ‹å­•å‘¨æ•°å€¼': 'min',
    'YæŸ“è‰²ä½“æµ“åº¦': 'first',
    'å­•å¦‡BMI': 'first',
    'å¹´é¾„': 'first',
    'èº«é«˜': 'first',
    'ä½“é‡': 'first'
}).reset_index()

earliest_pass_df.rename(columns={'æ£€æµ‹å­•å‘¨æ•°å€¼': 'æœ€æ—©è¾¾æ ‡å­•å‘¨'}, inplace=True)

print(f"æ€»å­•å¦‡æ•°: {df_male['å­•å¦‡ä»£ç '].nunique()}")
print(f"æœ‰è¾¾æ ‡è®°å½•çš„å­•å¦‡æ•°: {len(earliest_pass_df)}")
print(f"è¾¾æ ‡å­•å¦‡æ¯”ä¾‹: {len(earliest_pass_df) / df_male['å­•å¦‡ä»£ç '].nunique() * 100:.1f}%")

# åˆå¹¶å›åŸå§‹æ•°æ®ï¼Œä¸ºæ¯ä¸ªå­•å¦‡æ·»åŠ æœ€æ—©è¾¾æ ‡æ—¶é—´
df_male = df_male.merge(earliest_pass_df[['å­•å¦‡ä»£ç ', 'æœ€æ—©è¾¾æ ‡å­•å‘¨']], on='å­•å¦‡ä»£ç ', how='left')

# å¯¹äºæ²¡æœ‰è¾¾æ ‡è®°å½•çš„å­•å¦‡ï¼Œè®¾ç½®æœ€æ—©è¾¾æ ‡å­•å‘¨ä¸ºNaN
df_male.loc[df_male['æœ€æ—©è¾¾æ ‡å­•å‘¨'].isna(), 'æœ€æ—©è¾¾æ ‡å­•å‘¨'] = np.nan

# ä½¿ç”¨æ¯ä¸ªå­•å¦‡çš„ç¬¬ä¸€æ¡è®°å½•è¿›è¡Œåˆ†æï¼ˆé¿å…é‡å¤ï¼‰
unique_patients = df_male.drop_duplicates('å­•å¦‡ä»£ç ').copy()

# å±‚æ¬¡èšç±»BMIåˆ†ç»„ï¼ˆåŸºäºå”¯ä¸€å­•å¦‡ï¼‰
bmi_data = unique_patients[['å­•å¦‡BMI']].dropna().values

n_clusters = 4
hierarchical = AgglomerativeClustering(n_clusters=n_clusters, metric='euclidean', linkage='ward')
unique_patients['BMIåˆ†ç»„'] = hierarchical.fit_predict(bmi_data)

# æŒ‰å¹³å‡BMIæ’åºåˆ†ç»„ï¼Œç¡®ä¿åˆ†ç»„æŒ‰BMIå€¼é€’å¢
group_order = unique_patients.groupby('BMIåˆ†ç»„')['å­•å¦‡BMI'].mean().sort_values().index
group_mapping = {old: new for new, old in enumerate(group_order)}
unique_patients['BMIåˆ†ç»„'] = unique_patients['BMIåˆ†ç»„'].map(group_mapping)

# å®šä¹‰ä¸´åºŠåˆ†ç»„åç§°
clinical_group_names = {
    0: "æ­£å¸¸/è¶…é‡",
    1: "è½»åº¦è‚¥èƒ–",
    2: "ä¸­åº¦è‚¥èƒ–",
    3: "é‡åº¦è‚¥èƒ–"
}
unique_patients['BMIä¸´åºŠåˆ†ç»„'] = unique_patients['BMIåˆ†ç»„'].map(clinical_group_names)


# æ„å»ºç”Ÿå­˜æ›²çº¿å‡½æ•°ï¼ˆç¬¬äºŒç±»é£é™©ï¼šæµ“åº¦ä¸è¾¾æ ‡é£é™©ï¼‰
def build_survival_curves(unique_patients):
    """ä¸ºæ¯ä¸ªBMIåˆ†ç»„æ„å»ºç”Ÿå­˜æ›²çº¿ï¼ˆæœªè¾¾æ ‡æ¦‚ç‡æ›²çº¿ï¼‰"""
    survival_curves = {}

    for group_id in range(n_clusters):
        group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_id]
        passed_data = group_data[~group_data['æœ€æ—©è¾¾æ ‡å­•å‘¨'].isna()]

        if len(passed_data) > 0:
            # åˆ›å»ºæ—¶é—´åºåˆ—
            weeks = np.arange(10, 30, 0.5)
            survival_prob = []

            for week in weeks:
                # è®¡ç®—åœ¨weekå‘¨æ—¶ä»æœªè¾¾æ ‡çš„æ¯”ä¾‹
                not_passed_ratio = len(passed_data[passed_data['æœ€æ—©è¾¾æ ‡å­•å‘¨'] > week]) / len(group_data)
                survival_prob.append(not_passed_ratio)

            # åˆ›å»ºæ’å€¼å‡½æ•°
            survival_func = interp1d(weeks, survival_prob, kind='linear',
                                     bounds_error=False, fill_value=(1.0, 0.0))
            survival_curves[group_id] = survival_func

            # ç»˜åˆ¶ç”Ÿå­˜æ›²çº¿
            plt.figure(figsize=(10, 6))
            plt.plot(weeks, survival_prob, 'b-', linewidth=2, label='æœªè¾¾æ ‡æ¦‚ç‡')
            plt.xlabel('å­•å‘¨')
            plt.ylabel('æœªè¾¾æ ‡æ¦‚ç‡')
            plt.title(f'BMIåˆ†ç»„ {group_id + 1} ({clinical_group_names[group_id]}) - ç”Ÿå­˜æ›²çº¿')
            plt.grid(True, alpha=0.3)
            plt.legend()
            plt.savefig(f'Q3-BMIåˆ†ç»„{group_id + 1}_ç”Ÿå­˜æ›²çº¿.png', dpi=300, bbox_inches='tight')
            plt.close()

    return survival_curves


# æ„å»ºç”Ÿå­˜æ›²çº¿
survival_curves = build_survival_curves(unique_patients)


# å®šä¹‰ç¬¬ä¸€ç±»é£é™©å‡½æ•°ï¼ˆæ²»ç–—çª—å£ç¼©çŸ­é£é™©ï¼‰
def treatment_window_risk(week):
    """
    ç¬¬ä¸€ç±»é£é™©ï¼šæ²»ç–—çª—å£ç¼©çŸ­é£é™©
    åŸºäºä¸´åºŠå®è·µï¼Œå­•å‘¨è¶Šæ™šï¼Œæ²»ç–—çª—å£è¶ŠçŸ­ï¼Œé£é™©è¶Šé«˜
    """
    if week <= 12:
        return 0.25# æ—©æœŸï¼Œé£é™©å¾ˆä½
    elif 12 < week <= 20:
        return 0.5 + (week - 12) * 0.05  # é£é™©çº¿æ€§å¢åŠ 
    elif 20 < week <= 24:
        return 0.9+ (week - 20) * 0.1  # é£é™©å¿«é€Ÿå¢åŠ 
    elif 24 < week <= 28:
        return 1.3 + (week - 24) * 0.15  # é£é™©æ€¥å‰§å¢åŠ 
    else:
        return 2.0  # ææ™šæœŸï¼Œé£é™©æé«˜


# ç»˜åˆ¶ç¬¬ä¸€ç±»é£é™©æ›²çº¿ï¼ˆæ²»ç–—çª—å£ç¼©çŸ­é£é™©ï¼‰
def plot_first_type_risk_curve():
    # ç”Ÿæˆå­•å‘¨æ•°æ®ç‚¹ï¼ˆ10åˆ°30å‘¨ï¼Œé—´éš”0.1å‘¨ä»¥ç¡®ä¿æ›²çº¿å¹³æ»‘ï¼‰
    weeks = np.linspace(10, 30, 200)
    # è®¡ç®—æ¯ä¸ªå­•å‘¨å¯¹åº”çš„ç¬¬ä¸€ç±»é£é™©å€¼
    risk1_values = [treatment_window_risk(week) for week in weeks]

    # åˆ›å»ºç”»å¸ƒ
    plt.figure(figsize=(12, 8))

    # ç»˜åˆ¶ç¬¬ä¸€ç±»é£é™©æ›²çº¿
    plt.plot(weeks, risk1_values, 'r-', linewidth=3, label='ç¬¬ä¸€ç±»é£é™©ï¼ˆæ²»ç–—çª—å£ç¼©çŸ­é£é™©ï¼‰')

    # æ·»åŠ é£é™©é˜¶æ®µåˆ†éš”çº¿
    stage_boundaries = [12, 20, 24, 28]
    for boundary in stage_boundaries:
        plt.axvline(x=boundary, color='gray', linestyle='--', alpha=0.7)

    # æ·»åŠ é˜¶æ®µæ ‡ç­¾
    plt.text(11, 0.15, 'â‰¤12å‘¨', ha='center', va='center', backgroundcolor='white')
    plt.text(16, 0.3, '12-20å‘¨', ha='center', va='center', backgroundcolor='white')
    plt.text(22, 0.7, '20-24å‘¨', ha='center', va='center', backgroundcolor='white')
    plt.text(26, 1.3, '24-28å‘¨', ha='center', va='center', backgroundcolor='white')
    plt.text(29, 1.8, '>28å‘¨', ha='center', va='center', backgroundcolor='white')

    # è®¾ç½®åæ ‡è½´å’Œæ ‡é¢˜
    plt.xlabel('å­•å‘¨', fontsize=14)
    plt.ylabel('é£é™©å€¼', fontsize=14)
    plt.title('ç¬¬ä¸€ç±»é£é™©æ›²çº¿ï¼šæ²»ç–—çª—å£ç¼©çŸ­é£é™©éšå­•å‘¨å˜åŒ–', fontsize=16, pad=20)
    plt.xlim(10, 30)
    plt.ylim(0, 2.2)
    plt.grid(True, alpha=0.3)
    plt.legend(fontsize=12)

    # ä¿å­˜å›¾åƒ
    plt.savefig('Q3-ç¬¬ä¸€ç±»é£é™©æ›²çº¿.png', dpi=300, bbox_inches='tight')
    plt.close()
    print("ç¬¬ä¸€ç±»é£é™©æ›²çº¿å·²ä¿å­˜ä¸ºï¼šQ3-ç¬¬ä¸€ç±»é£é™©æ›²çº¿.png")


# è°ƒç”¨å‡½æ•°ç”Ÿæˆç¬¬ä¸€ç±»é£é™©æ›²çº¿
plot_first_type_risk_curve()

# -------------------------- æ ¸å¿ƒä¿®æ”¹ï¼šç¬¬äºŒç±»é£é™©æƒé‡å‡½æ•° --------------------------
# æ”¹ä¸ºï¼šBMI<25æ—¶æƒé‡å›ºå®šä¸º1.0ï¼ˆæ­£å¸¸å€¼ï¼‰ï¼ŒBMIâ‰¥25åæƒé‡ä¸BMIå‘ˆçº¿æ€§é€’å¢
def failure_risk_weight(bmi):
    """
    ç¬¬äºŒç±»é£é™©æƒé‡ï¼šæµ“åº¦ä¸è¾¾æ ‡çš„é£é™©æƒé‡
    é€»è¾‘ï¼šBMI<25ï¼ˆæ­£å¸¸ï¼‰æƒé‡å›ºå®š1.0ï¼›BMIâ‰¥25åï¼Œæƒé‡éšBMIçº¿æ€§é€’å¢ï¼ˆæ–œç‡0.08ï¼Œç¡®ä¿é£é™©å¢é•¿åˆç†ï¼‰
    å…¬å¼ï¼šweight = 1.0 + 0.08 * (bmi - 25) ï¼ˆå½“bmiâ‰¥25æ—¶ï¼‰
    """
    if bmi < 25:
        return 1.0  # BMIæ­£å¸¸èŒƒå›´ï¼Œæƒé‡å›ºå®šï¼ˆæ— é¢å¤–é£é™©ï¼‰
    else:
        # BMIâ‰¥25åçº¿æ€§é€’å¢ï¼šæ–œç‡0.08ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼Œæ–œç‡è¶Šå¤§æƒé‡å¢é•¿è¶Šå¿«ï¼‰
        # ç¤ºä¾‹ï¼šBMI=25â†’1.0ï¼ŒBMI=30â†’1.4ï¼ŒBMI=35â†’1.8ï¼ŒBMI=40â†’2.2ï¼ŒBMI=45â†’2.6ï¼ˆç¬¦åˆä¸´åºŠé£é™©è¶‹åŠ¿ï¼‰
        return 1.0 + 0.15 * (bmi - 25)



# ç»¼åˆé£é™©è®¡ç®—å‡½æ•°
def combined_risk(week, bmi, group_id, survival_curves):
    """
    è®¡ç®—ç»¼åˆé£é™© = ç¬¬ä¸€ç±»é£é™© + ç¬¬äºŒç±»é£é™© Ã— æƒé‡
    """
    # ç¬¬ä¸€ç±»é£é™©ï¼šæ²»ç–—çª—å£ç¼©çŸ­é£é™©
    risk1 = treatment_window_risk(week)

    # ç¬¬äºŒç±»é£é™©ï¼šæµ“åº¦ä¸è¾¾æ ‡é£é™©ï¼ˆä»ç”Ÿå­˜æ›²çº¿è·å–ï¼‰
    if group_id in survival_curves:
        risk2_prob = survival_curves[group_id](week)
    else:
        risk2_prob = 1.0  # é»˜è®¤é«˜é£é™©

    # ç¬¬äºŒç±»é£é™©æƒé‡
    weight = failure_risk_weight(bmi)

    # ç»¼åˆé£é™©
    total_risk = risk1 + risk2_prob * weight

    return total_risk, risk1, risk2_prob, weight


# ä¸ºæ¯ä¸ªåˆ†ç»„å¯»æ‰¾æœ€ä¼˜æ£€æµ‹æ—¶ç‚¹
def find_optimal_weeks(unique_patients, survival_curves):
    """ä¸ºæ¯ä¸ªBMIåˆ†ç»„å¯»æ‰¾é£é™©æœ€å°çš„æœ€ä¼˜æ£€æµ‹æ—¶ç‚¹"""
    optimal_weeks = {}

    for group_id in range(n_clusters):
        group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_id]
        if len(group_data) == 0:
            continue

        avg_bmi = group_data['å­•å¦‡BMI'].mean()
        group_name = clinical_group_names[group_id]

        # åœ¨10-28å‘¨èŒƒå›´å†…æœç´¢æœ€ä¼˜æ—¶ç‚¹
        weeks = np.linspace(10, 28, 100)
        risks = []
        risk1_values = []
        risk2_values = []

        for week in weeks:
            total_risk, risk1, risk2_prob, weight = combined_risk(week, avg_bmi, group_id, survival_curves)
            risks.append(total_risk)
            risk1_values.append(risk1)
            risk2_values.append(risk2_prob * weight)

        # æ‰¾åˆ°é£é™©æœ€å°çš„æ—¶ç‚¹
        min_risk_idx = np.argmin(risks)
        optimal_week = weeks[min_risk_idx]
        min_risk = risks[min_risk_idx]

        optimal_weeks[group_id] = {
            'optimal_week': optimal_week,
            'min_risk': min_risk,
            'risk1_at_optimal': risk1_values[min_risk_idx],
            'risk2_at_optimal': risk2_values[min_risk_idx],
            'group_name': group_name,
            'avg_bmi': avg_bmi
        }

        # ç»˜åˆ¶é£é™©æ›²çº¿
        plt.figure(figsize=(12, 8))
        plt.plot(weeks, risks, 'b-', linewidth=3, label='ç»¼åˆé£é™©')
        plt.plot(weeks, risk1_values, 'r--', linewidth=2, label='æ²»ç–—çª—å£é£é™©(ç¬¬ä¸€ç±»)')
        plt.plot(weeks, risk2_values, 'g--', linewidth=2, label='æµ“åº¦ä¸è¾¾æ ‡é£é™©(ç¬¬äºŒç±»)')
        plt.axvline(x=optimal_week, color='k', linestyle=':', label=f'æœ€ä¼˜æ—¶ç‚¹: {optimal_week:.1f}å‘¨')
        plt.xlabel('æ£€æµ‹å­•å‘¨')
        plt.ylabel('é£é™©å€¼')
        plt.title(f'BMIåˆ†ç»„ {group_id + 1} ({group_name}) - é£é™©æ›²çº¿\nå¹³å‡BMI: {avg_bmi:.1f}')
        plt.legend()
        plt.grid(True, alpha=0.3)
        plt.savefig(f'Q3-BMIåˆ†ç»„{group_id + 1}_é£é™©æ›²çº¿.png', dpi=300, bbox_inches='tight')
        plt.close()

    return optimal_weeks


# å¯»æ‰¾æœ€ä¼˜æ£€æµ‹æ—¶ç‚¹
optimal_weeks = find_optimal_weeks(unique_patients, survival_curves)

# è¾“å‡ºç»“æœ
print("=" * 100)
print("åŸºäºä¸¤ç±»é£é™©ç»¼åˆè¯„ä¼°çš„æœ€ä¼˜NIPTæ£€æµ‹æ—¶ç‚¹å»ºè®®")
print("=" * 100)
print("é£é™©è¯´æ˜:")
print("- ç¬¬ä¸€ç±»é£é™©: æ²»ç–—çª—å£ç¼©çŸ­é£é™© (å­•å‘¨è¶Šæ™šé£é™©è¶Šé«˜)")
print("- ç¬¬äºŒç±»é£é™©: æµ“åº¦ä¸è¾¾æ ‡é£é™© Ã— BMIæƒé‡ (BMIè¶Šé«˜æƒé‡è¶Šå¤§)")
print("- ç»¼åˆé£é™© = ç¬¬ä¸€ç±»é£é™© + ç¬¬äºŒç±»é£é™©")
print()

for group_id, result in optimal_weeks.items():
    group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_id]
    bmi_min = group_data['å­•å¦‡BMI'].min()
    bmi_max = group_data['å­•å¦‡BMI'].max()
    total_patients = len(group_data)

    print(f"BMIåˆ†ç»„ {group_id + 1} ({result['group_name']}, BMIèŒƒå›´: {bmi_min:.1f}-{bmi_max:.1f}):")
    print(f"  æ¨èæ£€æµ‹å­•å‘¨: {result['optimal_week']:.1f} å‘¨")
    print(f"  æœ€å°ç»¼åˆé£é™©å€¼: {result['min_risk']:.3f}")
    print(f"  ç¬¬ä¸€ç±»é£é™©(æ²»ç–—çª—å£): {result['risk1_at_optimal']:.3f}")
    print(f"  ç¬¬äºŒç±»é£é™©(æ£€æµ‹å¤±è´¥): {result['risk2_at_optimal']:.3f}")

    # ä¸´åºŠå»ºè®®
    if result['min_risk'] < 1.0:
        risk_level = "ä½é£é™©"
        suggestion = "å¸¸è§„æ£€æµ‹æµç¨‹ï¼ŒæˆåŠŸç‡è¾ƒé«˜"
    elif result['min_risk'] < 2.0:
        risk_level = "ä¸­é£é™©"
        suggestion = "å»ºè®®æå‰å‡†å¤‡ï¼Œæ£€æµ‹åå¯†åˆ‡è·Ÿè¸ªç»“æœ"
    elif result['min_risk'] < 3.0:
        risk_level = "é«˜é£é™©"
        suggestion = "éœ€è¦ç‰¹æ®Šå‡†å¤‡ï¼Œå»ºè®®ç»“åˆå…¶ä»–æ£€æµ‹æ‰‹æ®µ"
    else:
        risk_level = "æé«˜é£é™©"
        suggestion = "å¼ºçƒˆå»ºè®®é‡‡ç”¨æ›¿ä»£æ£€æµ‹æ–¹æ¡ˆ"

    print(f"  é£é™©ç­‰çº§: {risk_level}")
    print(f"  ğŸ’¡ ä¸´åºŠå»ºè®®: {suggestion}")
    print("-" * 100)

# ç»˜åˆ¶æ‰€æœ‰åˆ†ç»„çš„é£é™©æ›²çº¿å¯¹æ¯”
plt.figure(figsize=(14, 8))
weeks = np.linspace(10, 28, 100)

for group_id in range(n_clusters):
    if group_id in optimal_weeks:
        group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_id]
        avg_bmi = group_data['å­•å¦‡BMI'].mean()

        risks = []
        for week in weeks:
            total_risk, _, _, _ = combined_risk(week, avg_bmi, group_id, survival_curves)
            risks.append(total_risk)

        plt.plot(weeks, risks, label=f'åˆ†ç»„{group_id + 1}({clinical_group_names[group_id]}, BMI:{avg_bmi:.1f})',
                 linewidth=2)

plt.xlabel('æ£€æµ‹å­•å‘¨')
plt.ylabel('ç»¼åˆé£é™©å€¼')
plt.title('å„BMIåˆ†ç»„çš„ç»¼åˆé£é™©æ›²çº¿å¯¹æ¯”')
plt.legend()
plt.grid(True, alpha=0.3)
plt.axhline(y=0, color='k', linestyle='-', alpha=0.3)
plt.savefig('Q3-æ‰€æœ‰åˆ†ç»„é£é™©æ›²çº¿å¯¹æ¯”.png', dpi=300, bbox_inches='tight')
plt.close()

print("\næ‰€æœ‰å›¾è¡¨å·²ä¿å­˜å®Œæ¯•ï¼")
print("æ–‡ä»¶åè¯´æ˜:")
print("- Q3-BMIåˆ†ç»„X_ç”Ÿå­˜æ›²çº¿.png: å„åˆ†ç»„çš„æœªè¾¾æ ‡æ¦‚ç‡æ›²çº¿")
print("- Q3-BMIåˆ†ç»„X_é£é™©æ›²çº¿.png: å„åˆ†ç»„çš„é£é™©åˆ†è§£æ›²çº¿")
print("- Q3-æ‰€æœ‰åˆ†ç»„é£é™©æ›²çº¿å¯¹æ¯”.png: æ‰€æœ‰åˆ†ç»„çš„é£é™©å¯¹æ¯”")
