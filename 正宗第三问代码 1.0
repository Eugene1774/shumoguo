import pandas as pd
import numpy as np
from sklearn.cluster import AgglomerativeClustering
from sklearn.ensemble import RandomForestRegressor, RandomForestClassifier
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.metrics import mean_squared_error, r2_score, accuracy_score
from sklearn.preprocessing import StandardScaler
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.cluster.hierarchy import dendrogram, linkage
import matplotlib
import re
from scipy.interpolate import interp1d
from scipy.stats import norm, pearsonr
import warnings

warnings.filterwarnings('ignore')

# è®¾ç½®ä¸­æ–‡å­—ä½“
matplotlib.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans']
matplotlib.rcParams['axes.unicode_minus'] = False

# è¯»å–æ•°æ®
df_male = pd.read_csv('cleaned_dataæœ€ç»ˆ(1).csv')


# è½¬æ¢å­•å‘¨æ ¼å¼ä¸ºæ•°å€¼
def convert_week_to_numeric(week_str):
    if pd.isna(week_str):
        return np.nan
    if isinstance(week_str, (int, float)):
        return week_str

    week_str = str(week_str).lower().replace('å‘¨', '').replace('w', '')
    match = re.search(r'(\d+)(?:\+(\d+))?', week_str)
    if match:
        weeks = int(match.group(1))
        days = int(match.group(2)) if match.group(2) else 0
        return weeks + days / 7
    return np.nan


df_male['æ£€æµ‹å­•å‘¨æ•°å€¼'] = df_male['æ£€æµ‹å­•å‘¨'].apply(convert_week_to_numeric)

# æ ‡è®°è¾¾æ ‡æ ·æœ¬
df_male['è¾¾æ ‡'] = df_male['YæŸ“è‰²ä½“æµ“åº¦'] >= 0.04

# å¯¹æ¯ä¸ªå­•å¦‡ï¼Œæ‰¾åˆ°æœ€æ—©è¾¾æ ‡çš„æ£€æµ‹æ—¶é—´
earliest_pass_df = df_male[df_male['è¾¾æ ‡']].groupby('å­•å¦‡ä»£ç ').agg({
    'æ£€æµ‹å­•å‘¨æ•°å€¼': 'min',
    'YæŸ“è‰²ä½“æµ“åº¦': 'first',
    'å­•å¦‡BMI': 'first',
    'å¹´é¾„': 'first',
    'èº«é«˜': 'first',
    'ä½“é‡': 'first',
    'GCå«é‡': 'first',
    'è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹': 'first',
    'XæŸ“è‰²ä½“æµ“åº¦': 'first',
    'æ£€æµ‹æŠ½è¡€æ¬¡æ•°': 'first',
    'åŸå§‹è¯»æ®µæ•°': 'first',
    '18å·æŸ“è‰²ä½“çš„Zå€¼': 'first'
}).reset_index()

earliest_pass_df.rename(columns={'æ£€æµ‹å­•å‘¨æ•°å€¼': 'æœ€æ—©è¾¾æ ‡å­•å‘¨'}, inplace=True)

print(f"æ€»å­•å¦‡æ•°: {df_male['å­•å¦‡ä»£ç '].nunique()}")
print(f"æœ‰è¾¾æ ‡è®°å½•çš„å­•å¦‡æ•°: {len(earliest_pass_df)}")
print(f"è¾¾æ ‡å­•å¦‡æ¯”ä¾‹: {len(earliest_pass_df) / df_male['å­•å¦‡ä»£ç '].nunique() * 100:.1f}%")

# åˆå¹¶å›åŸå§‹æ•°æ®ï¼Œä¸ºæ¯ä¸ªå­•å¦‡æ·»åŠ æœ€æ—©è¾¾æ ‡æ—¶é—´
df_male = df_male.merge(earliest_pass_df[['å­•å¦‡ä»£ç ', 'æœ€æ—©è¾¾æ ‡å­•å‘¨']], on='å­•å¦‡ä»£ç ', how='left')

# å¯¹äºæ²¡æœ‰è¾¾æ ‡è®°å½•çš„å­•å¦‡ï¼Œè®¾ç½®æœ€æ—©è¾¾æ ‡å­•å‘¨ä¸ºNaN
df_male.loc[df_male['æœ€æ—©è¾¾æ ‡å­•å‘¨'].isna(), 'æœ€æ—©è¾¾æ ‡å­•å‘¨'] = np.nan

# ä½¿ç”¨æ¯ä¸ªå­•å¦‡çš„ç¬¬ä¸€æ¡è®°å½•è¿›è¡Œåˆ†æï¼ˆé¿å…é‡å¤ï¼‰
unique_patients = df_male.drop_duplicates('å­•å¦‡ä»£ç ').copy()

# åˆ†æå„å˜é‡ä¸YæŸ“è‰²ä½“æµ“åº¦çš„ç›¸å…³æ€§
correlation_vars = ['å¹´é¾„', 'èº«é«˜', 'GCå«é‡', 'XæŸ“è‰²ä½“æµ“åº¦', 'æ£€æµ‹æŠ½è¡€æ¬¡æ•°', 'åŸå§‹è¯»æ®µæ•°', '18å·æŸ“è‰²ä½“çš„Zå€¼']
correlation_results = {}

for var in correlation_vars:
    if var in df_male.columns and not df_male[var].isna().all() and not df_male['YæŸ“è‰²ä½“æµ“åº¦'].isna().all():
        # è¿‡æ»¤NaNå€¼åè®¡ç®—ç›¸å…³æ€§
        valid_data = df_male[[var, 'YæŸ“è‰²ä½“æµ“åº¦']].dropna()
        if len(valid_data) > 2:  # è‡³å°‘3ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹æ‰è®¡ç®—ç›¸å…³æ€§
            corr, p_value = pearsonr(valid_data[var], valid_data['YæŸ“è‰²ä½“æµ“åº¦'])
            correlation_results[var] = {'correlation': corr, 'p_value': p_value}
            print(f"{var} ä¸YæŸ“è‰²ä½“æµ“åº¦çš„ç›¸å…³æ€§: {corr:.3f} (p={p_value:.3e})")
        else:
            print(f"{var} æœ‰æ•ˆæ•°æ®ç‚¹ä¸è¶³ï¼Œæ— æ³•è®¡ç®—ç›¸å…³æ€§")
    else:
        print(f"{var} åˆ—ä¸å­˜åœ¨æˆ–æ•°æ®å…¨ä¸ºNaNï¼Œæ— æ³•è®¡ç®—ç›¸å…³æ€§")

# åŸºäºç›¸å…³æ€§åˆ†æåˆ†é…é£é™©ç³»æ•°
# æ­£ç›¸å…³å˜é‡ä¼šé™ä½é£é™©ï¼ˆæ­£ç³»æ•°ï¼‰ï¼Œè´Ÿç›¸å…³å˜é‡ä¼šå¢åŠ é£é™©ï¼ˆè´Ÿç³»æ•°ï¼‰
risk_coefficients = {
    'å¹´é¾„': -0.1,  # å¹´é¾„ä¸YæŸ“è‰²ä½“æµ“åº¦è´Ÿç›¸å…³â†’å¢åŠ é£é™©
    'èº«é«˜': 0.05,  # èº«é«˜ä¸YæŸ“è‰²ä½“æµ“åº¦æ­£ç›¸å…³â†’é™ä½é£é™©
    'GCå«é‡': 0.08,  # GCå«é‡ä¸YæŸ“è‰²ä½“æµ“åº¦æ­£ç›¸å…³â†’é™ä½é£é™©
    'XæŸ“è‰²ä½“æµ“åº¦': -0.15,  # XæŸ“è‰²ä½“æµ“åº¦ä¸YæŸ“è‰²ä½“æµ“åº¦è´Ÿç›¸å…³â†’å¢åŠ é£é™©
    'æ£€æµ‹æŠ½è¡€æ¬¡æ•°': -0.05,  # æ£€æµ‹æŠ½è¡€æ¬¡æ•°ä¸YæŸ“è‰²ä½“æµ“åº¦è´Ÿç›¸å…³â†’å¢åŠ é£é™©
    'åŸå§‹è¯»æ®µæ•°': 0.1,  # åŸå§‹è¯»æ®µæ•°ä¸YæŸ“è‰²ä½“æµ“åº¦æ­£ç›¸å…³â†’é™ä½é£é™©
    '18å·æŸ“è‰²ä½“çš„Zå€¼': -0.07  # 18å·æŸ“è‰²ä½“Zå€¼ä¸YæŸ“è‰²ä½“æµ“åº¦è´Ÿç›¸å…³â†’å¢åŠ é£é™©
}

# å‡†å¤‡æ•°æ®ç”¨äºé¢„æµ‹æœ€æ—©è¾¾æ ‡æ—¶é—´
# åªä½¿ç”¨æœ‰è¾¾æ ‡è®°å½•çš„æ ·æœ¬
train_data = earliest_pass_df[
    ['å­•å¦‡BMI', 'å¹´é¾„', 'èº«é«˜', 'ä½“é‡', 'GCå«é‡', 'è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹',
     'XæŸ“è‰²ä½“æµ“åº¦', 'æ£€æµ‹æŠ½è¡€æ¬¡æ•°', 'åŸå§‹è¯»æ®µæ•°', '18å·æŸ“è‰²ä½“çš„Zå€¼', 'æœ€æ—©è¾¾æ ‡å­•å‘¨']].dropna()

# ç‰¹å¾å’Œç›®æ ‡å˜é‡
if len(train_data) > 0:
    X = train_data[['å­•å¦‡BMI', 'å¹´é¾„', 'èº«é«˜', 'ä½“é‡', 'GCå«é‡', 'è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹',
                    'XæŸ“è‰²ä½“æµ“åº¦', 'æ£€æµ‹æŠ½è¡€æ¬¡æ•°', 'åŸå§‹è¯»æ®µæ•°', '18å·æŸ“è‰²ä½“çš„Zå€¼']]
    y = train_data['æœ€æ—©è¾¾æ ‡å­•å‘¨']

    # æ ‡å‡†åŒ–ç‰¹å¾
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)

    # è®­ç»ƒéšæœºæ£®æ—å›å½’æ¨¡å‹é¢„æµ‹æœ€æ—©è¾¾æ ‡æ—¶é—´
    rf_regressor = RandomForestRegressor(n_estimators=100, random_state=42, max_depth=5)
    rf_regressor.fit(X_scaled, y)

    # äº¤å‰éªŒè¯è¯„ä¼°æ¨¡å‹
    cv_scores = cross_val_score(rf_regressor, X_scaled, y, cv=5, scoring='r2')
    print(f"éšæœºæ£®æ—å›å½’æ¨¡å‹RÂ²åˆ†æ•°: {np.mean(cv_scores):.3f} (Â±{np.std(cv_scores):.3f})")

    # ç‰¹å¾é‡è¦æ€§
    feature_importance = pd.DataFrame({
        'feature': X.columns,
        'importance': rf_regressor.feature_importances_
    }).sort_values('importance', ascending=False)

    print("\nç‰¹å¾é‡è¦æ€§:")
    print(feature_importance)

    # ä¸ºæ‰€æœ‰å­•å¦‡é¢„æµ‹æœ€æ—©è¾¾æ ‡æ—¶é—´
    prediction_data = unique_patients[['å­•å¦‡BMI', 'å¹´é¾„', 'èº«é«˜', 'ä½“é‡', 'GCå«é‡', 'è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹',
                                       'XæŸ“è‰²ä½“æµ“åº¦', 'æ£€æµ‹æŠ½è¡€æ¬¡æ•°', 'åŸå§‹è¯»æ®µæ•°', '18å·æŸ“è‰²ä½“çš„Zå€¼']].copy()
    # ç”¨ä¸­ä½æ•°å¡«å……ç¼ºå¤±å€¼
    prediction_data_filled = prediction_data.fillna(prediction_data.median())
    prediction_data_scaled = scaler.transform(prediction_data_filled)
    unique_patients['é¢„æµ‹æœ€æ—©è¾¾æ ‡å­•å‘¨'] = rf_regressor.predict(prediction_data_scaled)

    # å¯¹äºæœ‰å®é™…è¾¾æ ‡æ—¶é—´çš„ï¼Œä½¿ç”¨å®é™…å€¼ï¼›æ²¡æœ‰çš„ï¼Œä½¿ç”¨é¢„æµ‹å€¼
    unique_patients['æœ€ç»ˆæœ€æ—©è¾¾æ ‡å­•å‘¨'] = unique_patients['æœ€æ—©è¾¾æ ‡å­•å‘¨'].fillna(unique_patients['é¢„æµ‹æœ€æ—©è¾¾æ ‡å­•å‘¨'])
else:
    print("âš ï¸  æœ‰æ•ˆè®­ç»ƒæ•°æ®ä¸è¶³ï¼Œæ— æ³•è®­ç»ƒé¢„æµ‹æ¨¡å‹ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹è¾¾æ ‡æ—¶é—´")
    unique_patients['æœ€ç»ˆæœ€æ—©è¾¾æ ‡å­•å‘¨'] = unique_patients['æœ€æ—©è¾¾æ ‡å­•å‘¨']

# æ£€æµ‹è¯¯å·®æ¨¡å‹ - ä¼°è®¡YæŸ“è‰²ä½“æµ“åº¦çš„æµ‹é‡è¯¯å·®
# è®¡ç®—åŒä¸€å­•å¦‡å¤šæ¬¡æ£€æµ‹çš„æ ‡å‡†å·®ä½œä¸ºæµ‹é‡è¯¯å·®çš„ä¼°è®¡
measurement_errors = df_male.groupby('å­•å¦‡ä»£ç ')['YæŸ“è‰²ä½“æµ“åº¦'].std().dropna()
avg_measurement_error = measurement_errors.mean() if not measurement_errors.empty else 0.01  # é»˜è®¤1%çš„è¯¯å·®

print(f"\nYæŸ“è‰²ä½“æµ“åº¦å¹³å‡æµ‹é‡è¯¯å·®: {avg_measurement_error:.4f}")

# ä½¿ç”¨æ›´ç²¾ç»†çš„BMIåˆ†ç»„ï¼ˆåŸºäºç™¾åˆ†ä½æ•°ï¼‰
valid_bmi = unique_patients['å­•å¦‡BMI'].dropna()
if len(valid_bmi) > 0:
    bmi_percentiles = np.percentile(valid_bmi, [0, 25, 50, 75, 100])
    # é¿å…ç™¾åˆ†ä½æ•°é‡å¤ï¼ˆå¦‚æ‰€æœ‰BMIç›¸åŒï¼‰
    bmi_percentiles = np.unique(bmi_percentiles)
    # ç¡®ä¿åˆ†ç»„æ•°ä¸º4ï¼ˆè‹¥æœ‰é‡å¤åˆ™è°ƒæ•´ï¼‰
    if len(bmi_percentiles) < 4:
        bmi_percentiles = np.linspace(valid_bmi.min(), valid_bmi.max(), 5)
    bmi_labels = ['åç˜¦', 'æ­£å¸¸', 'è¶…é‡', 'è‚¥èƒ–']

    unique_patients['BMIåˆ†ç»„'] = pd.cut(
        unique_patients['å­•å¦‡BMI'],
        bins=bmi_percentiles,
        labels=bmi_labels[:len(bmi_percentiles) - 1],  # é€‚é…å®é™…åˆ†ç®±æ•°
        include_lowest=True
    )
else:
    print("âš ï¸  æ— æœ‰æ•ˆBMIæ•°æ®ï¼Œæ— æ³•åˆ†ç»„")
    bmi_labels = []
    unique_patients['BMIåˆ†ç»„'] = np.nan

# å®šä¹‰ä¸´åºŠåˆ†ç»„åç§°
clinical_group_names = {}
if len(bmi_labels) > 0 and 'BMIåˆ†ç»„' in unique_patients.columns:
    for i, label in enumerate(bmi_labels):
        if i < len(bmi_percentiles) - 1:
            if i == 0:
                clinical_group_names[label] = f"åç˜¦ (BMI < {bmi_percentiles[1]:.1f})"
            elif i == 1:
                clinical_group_names[label] = f"æ­£å¸¸ ({bmi_percentiles[1]:.1f} â‰¤ BMI < {bmi_percentiles[2]:.1f})"
            elif i == 2:
                clinical_group_names[label] = f"è¶…é‡ ({bmi_percentiles[2]:.1f} â‰¤ BMI < {bmi_percentiles[3]:.1f})"
            elif i == 3:
                clinical_group_names[label] = f"è‚¥èƒ– (BMI â‰¥ {bmi_percentiles[3]:.1f})"


# æ„å»ºè€ƒè™‘æ£€æµ‹è¯¯å·®çš„ç”Ÿå­˜æ›²çº¿å‡½æ•°
def build_survival_curves_with_error(unique_patients, measurement_error):
    """ä¸ºæ¯ä¸ªBMIåˆ†ç»„æ„å»ºè€ƒè™‘æ£€æµ‹è¯¯å·®çš„ç”Ÿå­˜æ›²çº¿ï¼ˆæœªè¾¾æ ‡æ¦‚ç‡æ›²çº¿ï¼‰"""
    survival_curves = {}
    n_simulations = 1000  # è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ¬¡æ•°

    if 'BMIåˆ†ç»„' not in unique_patients.columns:
        return survival_curves

    for group_name in unique_patients['BMIåˆ†ç»„'].cat.categories:
        group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_name]
        if len(group_data) == 0 or group_data['æœ€ç»ˆæœ€æ—©è¾¾æ ‡å­•å‘¨'].isna().all():
            continue

        # åˆ›å»ºæ—¶é—´åºåˆ—
        weeks = np.arange(10, 30, 0.5)
        survival_prob = []

        for week in weeks:
            # è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿè€ƒè™‘æ£€æµ‹è¯¯å·®
            not_passed_count = 0

            for _, patient in group_data.iterrows():
                predicted_week = patient['æœ€ç»ˆæœ€æ—©è¾¾æ ‡å­•å‘¨']
                if pd.isna(predicted_week):
                    continue

                # è€ƒè™‘æ£€æµ‹è¯¯å·®ï¼šå®é™…è¾¾æ ‡æ—¶é—´å¯èƒ½æ¯”é¢„æµ‹çš„æ—©æˆ–æ™š
                # ä½¿ç”¨æ­£æ€åˆ†å¸ƒæ¨¡æ‹Ÿæ£€æµ‹è¯¯å·®
                error_weeks = np.random.normal(0, measurement_error * 2, n_simulations)  # è¯¯å·®æ”¾å¤§å› å­
                simulated_weeks = predicted_week + error_weeks

                # è®¡ç®—åœ¨weekå‘¨æ—¶ä»æœªè¾¾æ ‡çš„æ¯”ä¾‹
                not_passed = np.sum(simulated_weeks > week) / n_simulations
                not_passed_count += not_passed

            survival_prob.append(not_passed_count / len(group_data))

        # åˆ›å»ºæ’å€¼å‡½æ•°
        survival_func = interp1d(weeks, survival_prob, kind='linear',
                                 bounds_error=False, fill_value=(1.0, 0.0))
        survival_curves[group_name] = survival_func

        # ç»˜åˆ¶ç”Ÿå­˜æ›²çº¿
        plt.figure(figsize=(10, 6))
        plt.plot(weeks, survival_prob, 'b-', linewidth=2, label='æœªè¾¾æ ‡æ¦‚ç‡')
        plt.xlabel('å­•å‘¨')
        plt.ylabel('æœªè¾¾æ ‡æ¦‚ç‡')
        plt.title(f'BMIåˆ†ç»„ {group_name} - è€ƒè™‘æ£€æµ‹è¯¯å·®çš„ç”Ÿå­˜æ›²çº¿')
        plt.grid(True, alpha=0.3)
        plt.legend()
        plt.savefig(f'Q3-BMIåˆ†ç»„{group_name}_è€ƒè™‘è¯¯å·®çš„ç”Ÿå­˜æ›²çº¿.png', dpi=300, bbox_inches='tight')
        plt.close()

    return survival_curves


# æ„å»ºè€ƒè™‘æ£€æµ‹è¯¯å·®çš„ç”Ÿå­˜æ›²çº¿
survival_curves = build_survival_curves_with_error(unique_patients, avg_measurement_error)


# å®šä¹‰ç¬¬ä¸€ç±»é£é™©å‡½æ•°ï¼ˆæ²»ç–—çª—å£ç¼©çŸ­é£é™©ï¼‰
def treatment_window_risk(week):
    """
    ç¬¬ä¸€ç±»é£é™©ï¼šæ²»ç–—çª—å£ç¼©çŸ­é£é™©
    åŸºäºä¸´åºŠå®è·µï¼Œå­•å‘¨è¶Šæ™šï¼Œæ²»ç–—çª—å£è¶ŠçŸ­ï¼Œé£é™©è¶Šé«˜
    """
    if week <= 12:
        return 0.25  # æ—©æœŸï¼Œé£é™©å¾ˆä½
    elif 12 < week <= 20:
        return 0.5 + (week - 12) * 0.05  # é£é™©çº¿æ€§å¢åŠ 
    elif 20 < week <= 24:
        return 0.9 + (week - 20) * 0.1  # é£é™©å¿«é€Ÿå¢åŠ 
    elif 24 < week <= 28:
        return 1.3 + (week - 24) * 0.15  # é£é™©æ€¥å‰§å¢åŠ 
    else:
        return 2.0  # ææ™šæœŸï¼Œé£é™©æé«˜


# ç¬¬äºŒç±»é£é™©æƒé‡å‡½æ•° - æ›´æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å˜é‡
def failure_risk_weight(patient_data):
    """
    ç¬¬äºŒç±»é£é™©æƒé‡ï¼šæµ“åº¦ä¸è¾¾æ ‡çš„é£é™©æƒé‡
    ç»¼åˆè€ƒè™‘BMIã€å¹´é¾„ã€èº«é«˜ã€GCå«é‡ã€XæŸ“è‰²ä½“æµ“åº¦ã€æ£€æµ‹æŠ½è¡€æ¬¡æ•°ã€åŸå§‹è¯»æ®µæ•°ã€18å·æŸ“è‰²ä½“Zå€¼
    """
    # åŸºç¡€BMIæƒé‡
    bmi = patient_data['å­•å¦‡BMI']
    bmi_weight = 1.0
    if bmi >= 25:
        bmi_weight = 1.0 + 0.2 * (bmi - 25)

    # å¹´é¾„æƒé‡ï¼ˆå¹´é¾„è¶Šå¤§é£é™©è¶Šé«˜ï¼‰
    age = patient_data['å¹´é¾„']
    age_weight = 1.0 + 0.05 * max(0, age - 30)

    # è¿‡æ»¤è¯»æ•°æ¯”ä¾‹æƒé‡ï¼ˆè¿‡æ»¤æ¯”ä¾‹è¶Šé«˜ï¼Œæ•°æ®è´¨é‡è¶Šå·®ï¼Œé£é™©è¶Šé«˜ï¼‰
    filtered_ratio = patient_data['è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹']
    filtered_weight = 1.0 + 2.0 * filtered_ratio

    # åŸºç¡€æƒé‡
    base_weight = bmi_weight * age_weight * filtered_weight

    # æ–°å¢å˜é‡çš„é£é™©è°ƒæ•´
    additional_risk = 0

    # èº«é«˜é£é™©è°ƒæ•´
    height = patient_data.get('èº«é«˜', np.nan)
    if not pd.isna(height):
        additional_risk += risk_coefficients.get('èº«é«˜', 0) * (height - 140) / 5 # ä»¥140cmä¸ºåŸºå‡†ï¼Œæ¯5cmè°ƒæ•´

    # GCå«é‡é£é™©è°ƒæ•´
    gc_content = patient_data.get('GCå«é‡', np.nan)
    if not pd.isna(gc_content):
        additional_risk += risk_coefficients.get('GCå«é‡', 0) * (gc_content - 0.4) / 0.05  # ä»¥0.4ä¸ºåŸºå‡†ï¼Œæ¯0.05è°ƒæ•´

    # XæŸ“è‰²ä½“æµ“åº¦é£é™©è°ƒæ•´
    x_concentration = patient_data.get('XæŸ“è‰²ä½“æµ“åº¦', np.nan)
    if not pd.isna(x_concentration):
        additional_risk += risk_coefficients.get('XæŸ“è‰²ä½“æµ“åº¦', 0) * (x_concentration - 0.05) / 0.02  # ä»¥0.05ä¸ºåŸºå‡†ï¼Œæ¯0.02è°ƒæ•´

    # æ£€æµ‹æŠ½è¡€æ¬¡æ•°é£é™©è°ƒæ•´
    blood_test_count = patient_data.get('æ£€æµ‹æŠ½è¡€æ¬¡æ•°', np.nan)
    if not pd.isna(blood_test_count):
        additional_risk += risk_coefficients.get('æ£€æµ‹æŠ½è¡€æ¬¡æ•°', 0) * (blood_test_count - 1)  # ä»¥1æ¬¡ä¸ºåŸºå‡†

    # åŸå§‹è¯»æ®µæ•°é£é™©è°ƒæ•´
    raw_reads = patient_data.get('åŸå§‹è¯»æ®µæ•°', np.nan)
    if not pd.isna(raw_reads):
        additional_risk += risk_coefficients.get('åŸå§‹è¯»æ®µæ•°', 0) * (raw_reads - 4000000) / 1000000  # ä»¥400ä¸‡ä¸ºåŸºå‡†ï¼Œæ¯100ä¸‡è°ƒæ•´

    # 18å·æŸ“è‰²ä½“Zå€¼é£é™©è°ƒæ•´
    z_18 = patient_data.get('18å·æŸ“è‰²ä½“çš„Zå€¼', np.nan)
    if not pd.isna(z_18):
        additional_risk += risk_coefficients.get('18å·æŸ“è‰²ä½“çš„Zå€¼', 0) * z_18  # ç›´æ¥ä½¿ç”¨Zå€¼

    # ç»¼åˆæƒé‡
    total_weight = base_weight * (1 + additional_risk)

    return max(total_weight, 0.1)  # ç¡®ä¿æƒé‡ä¸ä½äº0.1


# ==============================================================================
# æ–°å¢ï¼šæ•´ç†å˜é‡æƒé‡ç³»æ•°æ•°æ®ï¼Œç”¨äºå¯è§†åŒ–
# ==============================================================================
def get_weight_coefficients_data():
    """æ•´ç†æ‰€æœ‰å‚ä¸æƒé‡è®¡ç®—çš„å˜é‡åŠå…¶ç³»æ•°ï¼ŒåŒºåˆ†åŸºç¡€æƒé‡å’Œé£é™©è°ƒæ•´ç³»æ•°"""
    # 1. åŸºç¡€æƒé‡å˜é‡ï¼ˆç›´æ¥å½±å“æƒé‡å€æ•°ï¼‰
    base_weight_vars = [
        {'å˜é‡åç§°': 'BMIï¼ˆâ‰¥25æ—¶ï¼‰', 'ç³»æ•°': 0.15, 'å½±å“æ–¹å‘': 'å¢åŠ é£é™©', 'è¯´æ˜': 'BMIâ‰¥25æ—¶ï¼Œæ¯å¢åŠ 1å•ä½ï¼Œæƒé‡+0.15'},
        {'å˜é‡åç§°': 'å¹´é¾„ï¼ˆ>30å²ï¼‰', 'ç³»æ•°': 0.01, 'å½±å“æ–¹å‘': 'å¢åŠ é£é™©', 'è¯´æ˜': 'å¹´é¾„>30å²æ—¶ï¼Œæ¯å¢åŠ 1å²ï¼Œæƒé‡+0.01'},
        {'å˜é‡åç§°': 'è¢«è¿‡æ»¤è¯»æ®µæ¯”ä¾‹', 'ç³»æ•°': 2.0, 'å½±å“æ–¹å‘': 'å¢åŠ é£é™©',
         'è¯´æ˜': 'è¿‡æ»¤æ¯”ä¾‹æ¯å¢åŠ 1å•ä½ï¼Œæƒé‡Ã—(1+2.0Ã—æ¯”ä¾‹)'},
    ]

    # 2. é£é™©è°ƒæ•´å˜é‡ï¼ˆé€šè¿‡additional_riskå½±å“æƒé‡ï¼Œç³»æ•°æ¥è‡ªrisk_coefficientsï¼‰
    risk_adjust_vars = [
        {'å˜é‡åç§°': 'èº«é«˜', 'ç³»æ•°': risk_coefficients['èº«é«˜'], 'å½±å“æ–¹å‘': 'é™ä½é£é™©',
         'è¯´æ˜': 'èº«é«˜æ¯é«˜äº160cm 10cmï¼Œé£é™©è°ƒæ•´-0.05'},
        {'å˜é‡åç§°': 'GCå«é‡', 'ç³»æ•°': risk_coefficients['GCå«é‡'], 'å½±å“æ–¹å‘': 'é™ä½é£é™©',
         'è¯´æ˜': 'GCå«é‡æ¯é«˜äº0.4 0.05ï¼Œé£é™©è°ƒæ•´-0.08'},
        {'å˜é‡åç§°': 'XæŸ“è‰²ä½“æµ“åº¦', 'ç³»æ•°': risk_coefficients['XæŸ“è‰²ä½“æµ“åº¦'], 'å½±å“æ–¹å‘': 'å¢åŠ é£é™©',
         'è¯´æ˜': 'Xæµ“åº¦æ¯é«˜äº0.05 0.02ï¼Œé£é™©è°ƒæ•´+0.15'},
        {'å˜é‡åç§°': 'æ£€æµ‹æŠ½è¡€æ¬¡æ•°', 'ç³»æ•°': risk_coefficients['æ£€æµ‹æŠ½è¡€æ¬¡æ•°'], 'å½±å“æ–¹å‘': 'å¢åŠ é£é™©',
         'è¯´æ˜': 'æŠ½è¡€æ¬¡æ•°æ¯å¤š1æ¬¡ï¼Œé£é™©è°ƒæ•´+0.05'},
        {'å˜é‡åç§°': 'åŸå§‹è¯»æ®µæ•°', 'ç³»æ•°': risk_coefficients['åŸå§‹è¯»æ®µæ•°'], 'å½±å“æ–¹å‘': 'é™ä½é£é™©',
         'è¯´æ˜': 'è¯»æ®µæ•°æ¯é«˜äº400ä¸‡100ä¸‡ï¼Œé£é™©è°ƒæ•´-0.1'},
        {'å˜é‡åç§°': '18å·æŸ“è‰²ä½“Zå€¼', 'ç³»æ•°': risk_coefficients['18å·æŸ“è‰²ä½“çš„Zå€¼'], 'å½±å“æ–¹å‘': 'å¢åŠ é£é™©',
         'è¯´æ˜': 'Zå€¼æ¯å¢åŠ 1ï¼Œé£é™©è°ƒæ•´+0.07'},
    ]

    # åˆå¹¶ä¸¤ç±»å˜é‡ï¼Œæ·»åŠ ç»Ÿä¸€æ ‡è¯†
    all_vars = base_weight_vars + risk_adjust_vars
    for var in all_vars:
        var['ç³»æ•°ç»å¯¹å€¼'] = abs(var['ç³»æ•°'])  # ç”¨äºæ’åº
    return pd.DataFrame(all_vars)


# è·å–æƒé‡ç³»æ•°æ•°æ®
weight_coef_df = get_weight_coefficients_data()


# ==============================================================================
# æ–°å¢ï¼šç»˜åˆ¶å˜é‡æƒé‡ç³»æ•°æ¡å½¢å›¾
# ==============================================================================
def plot_weight_coefficients(weight_coef_df):
    """ç»˜åˆ¶å˜é‡æƒé‡ç³»æ•°å›¾ï¼ŒåŒºåˆ†å¢åŠ /é™ä½é£é™©ï¼Œæ ‡æ³¨ç³»æ•°å’Œè¯´æ˜"""
    # è®¾ç½®å›¾å½¢å¤§å°å’Œé£æ ¼
    plt.figure(figsize=(14, 10))
    # æŒ‰ç³»æ•°ç»å¯¹å€¼æ’åºï¼Œè®©å½±å“å¤§çš„å˜é‡åœ¨ä¸Šæ–¹
    weight_coef_df_sorted = weight_coef_df.sort_values('ç³»æ•°ç»å¯¹å€¼', ascending=True)

    # å®šä¹‰é¢œè‰²ï¼šå¢åŠ é£é™©=çº¢è‰²ï¼Œé™ä½é£é™©=ç»¿è‰²
    colors = ['#FF6B6B' if x == 'å¢åŠ é£é™©' else '#4ECDC4' for x in weight_coef_df_sorted['å½±å“æ–¹å‘']]

    # ç»˜åˆ¶æ°´å¹³æ¡å½¢å›¾
    bars = plt.barh(
        y=weight_coef_df_sorted['å˜é‡åç§°'],
        width=weight_coef_df_sorted['ç³»æ•°'],
        color=colors,
        alpha=0.8,
        edgecolor='black',
        linewidth=0.5
    )

    # ä¸ºæ¯ä¸ªæ¡å½¢æ ‡æ³¨ç³»æ•°å€¼ï¼ˆä¿ç•™3ä½å°æ•°ï¼‰
    for i, (bar, coef) in enumerate(zip(bars, weight_coef_df_sorted['ç³»æ•°'])):
        width = bar.get_width()
        # ç³»æ•°ä¸ºæ­£æ—¶ï¼Œæ ‡ç­¾åœ¨æ¡å½¢å³ä¾§ï¼›ä¸ºè´Ÿæ—¶åœ¨å·¦ä¾§
        x_pos = width + 0.02 if width > 0 else width - 0.02
        plt.text(
            x=x_pos,
            y=bar.get_y() + bar.get_height() / 2,
            s=f'ç³»æ•°: {coef:.3f}',
            va='center',
            ha='left' if width > 0 else 'right',
            fontsize=10,
            fontweight='bold'
        )

    # æ·»åŠ å‚ç›´é›¶çº¿ï¼ˆåŒºåˆ†æ­£è´Ÿæ•°ï¼‰
    plt.axvline(x=0, color='black', linestyle='-', linewidth=1, alpha=0.5)

    # è®¾ç½®åæ ‡è½´å’Œæ ‡é¢˜
    plt.xlabel('æƒé‡ç³»æ•°ï¼ˆæ­£å€¼=é™ä½é£é™©ï¼Œè´Ÿå€¼=å¢åŠ é£é™©ï¼‰', fontsize=12, fontweight='bold')
    plt.ylabel('å˜é‡åç§°', fontsize=12, fontweight='bold')
    plt.title('å„å˜é‡å¯¹NIPTæ£€æµ‹é£é™©æƒé‡çš„å½±å“ç³»æ•°', fontsize=16, fontweight='bold', pad=20)

    # æ·»åŠ å›¾ä¾‹
    from matplotlib.patches import Patch
    legend_elements = [
        Patch(facecolor='#FF6B6B', alpha=0.8, label='å¢åŠ é£é™©'),
        Patch(facecolor='#4ECDC4', alpha=0.8, label='é™ä½é£é™©')
    ]
    plt.legend(handles=legend_elements, loc='lower right', fontsize=10)

    # æ·»åŠ æ³¨é‡Šè¯´æ˜ç‰¹æ®Šå˜é‡è§„åˆ™
    annotation_text = (
        'ç‰¹æ®Šè§„åˆ™è¯´æ˜ï¼š\n'
        '1. BMIï¼šâ‰¤25æ—¶åŸºç¡€æƒé‡=1.0ï¼Œâ‰¥25æ—¶æŒ‰ç³»æ•°0.15é€’å¢\n'
        '2. å¹´é¾„ï¼šâ‰¤30å²æ—¶åŸºç¡€æƒé‡=1.0ï¼Œ>30å²æ—¶æŒ‰ç³»æ•°0.01é€’å¢\n'
        '3. è¢«è¿‡æ»¤è¯»æ®µæ¯”ä¾‹ï¼šæƒé‡=1.0 + 2.0Ã—æ¯”ä¾‹ï¼ˆæ¯”ä¾‹èŒƒå›´0-1ï¼‰'
    )
    plt.text(
        0.02, 0.02,
        annotation_text,
        transform=plt.gca().transAxes,
        bbox=dict(boxstyle='round,pad=0.5', facecolor='wheat', alpha=0.8),
        fontsize=9,
        verticalalignment='bottom'
    )

    # è°ƒæ•´å¸ƒå±€ï¼Œé¿å…æ ‡ç­¾è¢«æˆªæ–­
    plt.tight_layout()
    # ä¿å­˜å›¾ç‰‡
    plt.savefig('Q3-å„å˜é‡é£é™©æƒé‡ç³»æ•°å›¾.png', dpi=300, bbox_inches='tight')
    plt.close()
    print("\nâœ… å˜é‡æƒé‡ç³»æ•°å›¾å·²ä¿å­˜ï¼šQ3-å„å˜é‡é£é™©æƒé‡ç³»æ•°å›¾.png")


# è°ƒç”¨å‡½æ•°ç»˜åˆ¶æƒé‡ç³»æ•°å›¾
plot_weight_coefficients(weight_coef_df)


# ==============================================================================
# ç»¼åˆé£é™©è®¡ç®—å‡½æ•°ï¼ˆåŸæœ‰ä»£ç ä¿ç•™ï¼‰
# ==============================================================================
def combined_risk(week, patient_data, group_name, survival_curves):
    """
    è®¡ç®—ç»¼åˆé£é™© = ç¬¬ä¸€ç±»é£é™© + ç¬¬äºŒç±»é£é™© Ã— æƒé‡
    """
    # ç¬¬ä¸€ç±»é£é™©ï¼šæ²»ç–—çª—å£ç¼©çŸ­é£é™©
    risk1 = treatment_window_risk(week)

    # ç¬¬äºŒç±»é£é™©ï¼šæµ“åº¦ä¸è¾¾æ ‡é£é™©ï¼ˆä»ç”Ÿå­˜æ›²çº¿è·å–ï¼‰
    risk2_prob = survival_curves.get(group_name, lambda x: 1.0)(week)

    # ç¬¬äºŒç±»é£é™©æƒé‡
    weight = failure_risk_weight(patient_data)

    # ç»¼åˆé£é™©
    total_risk = risk1 + risk2_prob * weight

    return total_risk, risk1, risk2_prob, weight


# ä¸ºæ¯ä¸ªåˆ†ç»„å¯»æ‰¾æœ€ä¼˜æ£€æµ‹æ—¶ç‚¹ï¼ˆåŸæœ‰ä»£ç ä¿ç•™ï¼Œé€‚é…åˆ†ç»„å¯èƒ½ä¸ºç©ºçš„æƒ…å†µï¼‰
def find_optimal_weeks(unique_patients, survival_curves):
    """ä¸ºæ¯ä¸ªBMIåˆ†ç»„å¯»æ‰¾é£é™©æœ€å°çš„æœ€ä¼˜æ£€æµ‹æ—¶ç‚¹"""
    optimal_weeks = {}
    if 'BMIåˆ†ç»„' not in unique_patients.columns:
        return optimal_weeks

    for group_name in unique_patients['BMIåˆ†ç»„'].cat.categories:
        group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_name]
        if len(group_data) == 0 or group_data[['å­•å¦‡BMI', 'å¹´é¾„', 'è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹']].isna().all().all():
            continue

        # è®¡ç®—ç»„å†…å¹³å‡ç‰¹å¾å€¼ï¼ˆå¡«å……NaNï¼‰
        avg_patient = {
            'å­•å¦‡BMI': group_data['å­•å¦‡BMI'].mean(),
            'å¹´é¾„': group_data['å¹´é¾„'].mean(),
            'è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹': group_data['è¢«è¿‡æ»¤æ‰è¯»æ®µæ•°çš„æ¯”ä¾‹'].mean(),
            'èº«é«˜': group_data['èº«é«˜'].mean() if not group_data['èº«é«˜'].isna().all() else 160,
            'GCå«é‡': group_data['GCå«é‡'].mean() if not group_data['GCå«é‡'].isna().all() else 0.4,
            'XæŸ“è‰²ä½“æµ“åº¦': group_data['XæŸ“è‰²ä½“æµ“åº¦'].mean() if not group_data['XæŸ“è‰²ä½“æµ“åº¦'].isna().all() else 0.05,
            'æ£€æµ‹æŠ½è¡€æ¬¡æ•°': group_data['æ£€æµ‹æŠ½è¡€æ¬¡æ•°'].mean() if not group_data['æ£€æµ‹æŠ½è¡€æ¬¡æ•°'].isna().all() else 1,
            'åŸå§‹è¯»æ®µæ•°': group_data['åŸå§‹è¯»æ®µæ•°'].mean() if not group_data['åŸå§‹è¯»æ®µæ•°'].isna().all() else 4000000,
            '18å·æŸ“è‰²ä½“çš„Zå€¼': group_data['18å·æŸ“è‰²ä½“çš„Zå€¼'].mean() if not group_data[
                '18å·æŸ“è‰²ä½“çš„Zå€¼'].isna().all() else 0
        }

        # åœ¨10-28å‘¨èŒƒå›´å†…æœç´¢æœ€ä¼˜æ—¶ç‚¹
        weeks = np.linspace(10, 28, 100)
        risks = []
        risk1_values = []
        risk2_values = []

        for week in weeks:
            total_risk, risk1, risk2_prob, weight = combined_risk(week, avg_patient, group_name, survival_curves)
            risks.append(total_risk)
            risk1_values.append(risk1)
            risk2_values.append(risk2_prob * weight)

        # æ‰¾åˆ°é£é™©æœ€å°çš„æ—¶ç‚¹
        if risks:
            min_risk_idx = np.argmin(risks)
            optimal_week = weeks[min_risk_idx]
            min_risk = risks[min_risk_idx]

            optimal_weeks[group_name] = {
                'optimal_week': optimal_week,
                'min_risk': min_risk,
                'risk1_at_optimal': risk1_values[min_risk_idx],
                'risk2_at_optimal': risk2_values[min_risk_idx],
                'group_name': group_name,
                'avg_patient': avg_patient
            }

            # ç»˜åˆ¶é£é™©æ›²çº¿
            plt.figure(figsize=(12, 8))
            plt.plot(weeks, risks, 'b-', linewidth=3, label='ç»¼åˆé£é™©')
            plt.plot(weeks, risk1_values, 'r--', linewidth=2, label='æ²»ç–—çª—å£é£é™©(ç¬¬ä¸€ç±»)')
            plt.plot(weeks, risk2_values, 'g--', linewidth=2, label='æµ“åº¦ä¸è¾¾æ ‡é£é™©(ç¬¬äºŒç±»)')
            plt.axvline(x=optimal_week, color='k', linestyle=':', label=f'æœ€ä¼˜æ—¶ç‚¹: {optimal_week:.1f}å‘¨')
            plt.xlabel('æ£€æµ‹å­•å‘¨')
            plt.ylabel('é£é™©å€¼')
            plt.title(
                f'BMIåˆ†ç»„ {group_name} - é£é™©æ›²çº¿\nå¹³å‡BMI: {avg_patient["å­•å¦‡BMI"]:.1f}, å¹³å‡å¹´é¾„: {avg_patient["å¹´é¾„"]:.1f}')
            plt.legend()
            plt.grid(True, alpha=0.3)
            plt.savefig(f'Q3-BMIåˆ†ç»„{group_name}_é£é™©æ›²çº¿.png', dpi=300, bbox_inches='tight')
            plt.close()

    return optimal_weeks


# å¯»æ‰¾æœ€ä¼˜æ£€æµ‹æ—¶ç‚¹
optimal_weeks = find_optimal_weeks(unique_patients, survival_curves)

# è¾“å‡ºç»“æœï¼ˆåŸæœ‰ä»£ç ä¿ç•™ï¼Œé€‚é…åˆ†ç»„å¯èƒ½ä¸ºç©ºçš„æƒ…å†µï¼‰
print("\n" + "=" * 100)
print("åŸºäºå¤šå› ç´ å’Œæ£€æµ‹è¯¯å·®è¯„ä¼°çš„æœ€ä¼˜NIPTæ£€æµ‹æ—¶ç‚¹å»ºè®®")
print("=" * 100)
print("é£é™©è¯´æ˜:")
print("- ç¬¬ä¸€ç±»é£é™©: æ²»ç–—çª—å£ç¼©çŸ­é£é™© (å­•å‘¨è¶Šæ™šé£é™©è¶Šé«˜)")
print(
    "- ç¬¬äºŒç±»é£é™©: æµ“åº¦ä¸è¾¾æ ‡é£é™© Ã— ç»¼åˆæƒé‡ (è€ƒè™‘BMIã€å¹´é¾„ã€èº«é«˜ã€GCå«é‡ã€XæŸ“è‰²ä½“æµ“åº¦ã€æ£€æµ‹æŠ½è¡€æ¬¡æ•°ã€åŸå§‹è¯»æ®µæ•°ã€18å·æŸ“è‰²ä½“Zå€¼)")
print("- ç»¼åˆé£é™© = ç¬¬ä¸€ç±»é£é™© + ç¬¬äºŒç±»é£é™©")
print(f"- æ£€æµ‹è¯¯å·®æ°´å¹³: {avg_measurement_error:.4f}")
print()

if optimal_weeks:
    for group_name, result in optimal_weeks.items():
        group_data = unique_patients[unique_patients['BMIåˆ†ç»„'] == group_name]
        bmi_min = group_data['å­•å¦‡BMI'].min() if not group_data['å­•å¦‡BMI'].isna().all() else np.nan
        bmi_max = group_data['å­•å¦‡BMI'].max() if not group_data['å­•å¦‡BMI'].isna().all() else np.nan
        total_patients = len(group_data)

        print(
            f"BMIåˆ†ç»„: {clinical_group_names.get(group_name, group_name)}, BMIèŒƒå›´: {bmi_min:.1f}-{bmi_max:.1f}" if not pd.isna(
                bmi_min) else f"BMIåˆ†ç»„: {group_name}")
        print(f"  å­•å¦‡æ•°é‡: {total_patients}")
        print(f"  å¹³å‡å¹´é¾„: {result['avg_patient']['å¹´é¾„']:.1f}å²")
        print(f"  å¹³å‡èº«é«˜: {result['avg_patient']['èº«é«˜']:.1f}cm")
        print(f"  å¹³å‡GCå«é‡: {result['avg_patient']['GCå«é‡']:.3f}")
        print(f"  å¹³å‡XæŸ“è‰²ä½“æµ“åº¦: {result['avg_patient']['XæŸ“è‰²ä½“æµ“åº¦']:.3f}")
        print(f"  å¹³å‡æ£€æµ‹æŠ½è¡€æ¬¡æ•°: {result['avg_patient']['æ£€æµ‹æŠ½è¡€æ¬¡æ•°']:.1f}")
        print(f"  å¹³å‡åŸå§‹è¯»æ®µæ•°: {result['avg_patient']['åŸå§‹è¯»æ®µæ•°']:.0f}")
        print(f"  å¹³å‡18å·æŸ“è‰²ä½“Zå€¼: {result['avg_patient']['18å·æŸ“è‰²ä½“çš„Zå€¼']:.2f}")
        print(f"  æ¨èæ£€æµ‹å­•å‘¨: {result['optimal_week']:.1f} å‘¨")
        print(f"  æœ€å°ç»¼åˆé£é™©å€¼: {result['min_risk']:.3f}")
        print(f"  ç¬¬ä¸€ç±»é£é™©(æ²»ç–—çª—å£): {result['risk1_at_optimal']:.3f}")
        print(f"  ç¬¬äºŒç±»é£é™©(æ£€æµ‹å¤±è´¥): {result['risk2_at_optimal']:.3f}")

        # ä¸´åºŠå»ºè®®
        if result['min_risk'] < 1.0:
            risk_level = "ä½é£é™©"
            suggestion = "å¸¸è§„æ£€æµ‹æµç¨‹ï¼ŒæˆåŠŸç‡è¾ƒé«˜"
        elif result['min_risk'] < 2.0:
            risk_level = "ä¸­é£é™©"
            suggestion = "å»ºè®®æå‰å‡†å¤‡ï¼Œæ£€æµ‹åå¯†åˆ‡è·Ÿè¸ªç»“æœ"
        elif result['min_risk'] < 3.0:
            risk_level = "é«˜é£é™©"
            suggestion = "éœ€è¦ç‰¹æ®Šå‡†å¤‡ï¼Œå»ºè®®ç»“åˆå…¶ä»–æ£€æµ‹æ‰‹æ®µ"
        else:
            risk_level = "æé«˜é£é™©"
            suggestion = "å¼ºçƒˆå»ºè®®é‡‡ç”¨æ›¿ä»£æ£€æµ‹æ–¹æ¡ˆ"

        print(f"  é£é™©ç­‰çº§: {risk_level}")
        print(f"  ğŸ’¡ ä¸´åºŠå»ºè®®: {suggestion}")
        print("-" * 100)
else:
    print("âš ï¸  æ— æœ‰æ•ˆBMIåˆ†ç»„æ•°æ®ï¼Œæ— æ³•è¾“å‡ºæœ€ä¼˜æ£€æµ‹æ—¶ç‚¹å»ºè®®")

# ç»˜åˆ¶æ‰€æœ‰åˆ†ç»„çš„é£é™©æ›²çº¿å¯¹æ¯”ï¼ˆåŸæœ‰ä»£ç ä¿ç•™ï¼Œé€‚é…åˆ†ç»„å¯èƒ½ä¸ºç©ºçš„æƒ…å†µï¼‰
if optimal_weeks and len(optimal_weeks) > 0:
    plt.figure(figsize=(14, 8))
    weeks = np.linspace(10, 28, 100)

    for group_name in optimal_weeks.keys():
        avg_patient = optimal_weeks[group_name]['avg_patient']
        risks = []
        for week in weeks:
            total_risk, _, _, _ = combined_risk(week, avg_patient, group_name, survival_curves)
            risks.append(total_risk)

        label = f'{group_name}(BMI:{avg_patient["å­•å¦‡BMI"]:.1f},å¹´é¾„:{avg_patient["å¹´é¾„"]:.1f})'
        plt.plot(weeks, risks, label=label, linewidth=2)

    plt.xlabel('æ£€æµ‹å­•å‘¨')
    plt.ylabel('ç»¼åˆé£é™©å€¼')
    plt.title('å„BMIåˆ†ç»„çš„ç»¼åˆé£é™©æ›²çº¿å¯¹æ¯”')
    plt.legend()
    plt.grid(True, alpha=0.3)
    plt.axhline(y=0, color='k', linestyle='-', alpha=0.3)
    plt.savefig('Q3-æ‰€æœ‰åˆ†ç»„é£é™©æ›²çº¿å¯¹æ¯”.png', dpi=300, bbox_inches='tight')
    plt.close()

# ç»˜åˆ¶ç‰¹å¾é‡è¦æ€§å›¾ï¼ˆåŸæœ‰ä»£ç ä¿ç•™ï¼Œé€‚é…æ¨¡å‹å¯èƒ½æœªè®­ç»ƒçš„æƒ…å†µï¼‰
if 'feature_importance' in locals():
    plt.figure(figsize=(10, 6))
    plt.barh(feature_importance['feature'], feature_importance['importance'])
    plt.xlabel('é‡è¦æ€§')
    plt.title('å½±å“æœ€æ—©è¾¾æ ‡æ—¶é—´çš„å› ç´ é‡è¦æ€§')
    plt.tight_layout()
    plt.savefig('Q3-ç‰¹å¾é‡è¦æ€§.png', dpi=300, bbox_inches='tight')
    plt.close()

print("\næ‰€æœ‰å›¾è¡¨å·²ä¿å­˜å®Œæ¯•ï¼")
print("æ–‡ä»¶åè¯´æ˜:")
print("- Q3-å„å˜é‡é£é™©æƒé‡ç³»æ•°å›¾.png: å„å˜é‡å¯¹é£é™©æƒé‡çš„å½±å“ç³»æ•°ï¼ˆæ–°å¢ï¼‰")
print("- Q3-BMIåˆ†ç»„X_è€ƒè™‘è¯¯å·®çš„ç”Ÿå­˜æ›²çº¿.png: å„åˆ†ç»„çš„è€ƒè™‘æ£€æµ‹è¯¯å·®çš„æœªè¾¾æ ‡æ¦‚ç‡æ›²çº¿")
print("- Q3-BMIåˆ†ç»„X_é£é™©æ›²çº¿.png: å„åˆ†ç»„çš„é£é™©åˆ†è§£æ›²çº¿")
print("- Q3-æ‰€æœ‰åˆ†ç»„é£é™©æ›²çº¿å¯¹æ¯”.png: æ‰€æœ‰åˆ†ç»„çš„é£é™©å¯¹æ¯”")
print("- Q3-ç‰¹å¾é‡è¦æ€§.png: å½±å“æœ€æ—©è¾¾æ ‡æ—¶é—´çš„å› ç´ é‡è¦æ€§")
